<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ED Occupancy: Mortality Impact Calculator</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.6.2/flatly/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>

    <style>
        .well {
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .scorecard-occ {
            background-color: #f7f9fa;
            border-left: 5px solid #2c3e50;
        }
        .scorecard-risk {
            background-color: #f7f9fa;
            border-left: 5px solid #e74c3c;
        }
        /* Dynamic coloring classes */
        .risk-text-positive { color: #e74c3c; font-weight: bold; }
        .risk-text-negative { color: #27ae60; font-weight: bold; }
        
        .footer-note {
            text-align: right; 
            font-style: italic; 
            color: #95a5a6; 
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12 mb-4">
            <h2>ED Occupancy: Mortality Impact Calculator</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">Current Status</div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="beds">Number of Staffed ED Beds:</label>
                        <input type="number" id="beds" class="form-control" value="50" min="1">
                    </div>
                    <div class="form-group">
                        <label for="patients">Number of Patients in Dept:</label>
                        <input type="number" id="patients" class="form-control" value="55" min="0">
                    </div>
                    <hr>
                    <p class="text-muted small">
                        Baseline is set to <span id="baseline_lbl">100%</span> occupancy (0% change).
                    </p>
                    <p class="text-muted small">
                        Positive percentages indicate increased mortality risk relative to this baseline.
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="well scorecard-occ">
                        <h5>Current Occupancy</h5>
                        <h2 id="current_occ_text">0.0%</h2>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="well scorecard-risk">
                        <h5>Change in Mortality Risk</h5>
                        <h2 id="risk_text" class="risk-text-positive">+0.0%</h2>
                        <div id="risk_ci_text" style="font-size: 0.9em; color: #7f8c8d;">
                            (95% CI: 0.0% to 0.0%)
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Projected Risk Curve</div>
                <div class="card-body">
                    <canvas id="riskChart" height="200"></canvas>
                    <div class="footer-note">Shaded area indicates 95% Confidence Interval.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // =======================================================
    // 1. CONFIGURATION (From your R Code)
    // =======================================================
    const CALIB_INTERCEPT = -2.834175;
    const BETA_OCCUPANCY  = 0.08645624;
    const VAR_OCCUPANCY   = 0.001713856;
    const BASELINE_OCC    = 1.0; 
    // =======================================================

    // Helper: Inverse Logit (Sigmoid)
    function inv_logit(x) {
        return 1.0 / (1.0 + Math.exp(-x));
    }

    // Helper: Format Percentage
    function fmtPct(val, decimals = 1, showPlus = false) {
        let p = val * 100;
        let s = p.toFixed(decimals) + "%";
        if (showPlus && p > 0) return "+" + s;
        return s;
    }

    // MAIN STATISTICAL FUNCTION
    // Replicates your 'get_relative_risk' R function exactly
    function get_relative_risk(occupancy) {
        // A. Baseline Probability (P0)
        const log_odds_base = CALIB_INTERCEPT + (BETA_OCCUPANCY * BASELINE_OCC);
        const p0 = inv_logit(log_odds_base);

        // B. Difference in Log-Odds
        const diff_occ = occupancy - BASELINE_OCC;
        const log_or = BETA_OCCUPANCY * diff_occ;

        // C. Standard Error of the Difference
        const se_log_or = Math.abs(diff_occ) * Math.sqrt(VAR_OCCUPANCY);

        // D. Interval on Odds Ratio Scale
        const or_est = Math.exp(log_or);
        const or_lwr = Math.exp(log_or - 1.96 * se_log_or);
        const or_upr = Math.exp(log_or + 1.96 * se_log_or);

        // E. Convert to Relative Risk (RR)
        // Formula: RR = OR / (1 - p0 + (p0 * OR))
        const rr_est = or_est / (1 - p0 + (p0 * or_est));
        const rr_lwr = or_lwr / (1 - p0 + (p0 * or_lwr));
        const rr_upr = or_upr / (1 - p0 + (p0 * or_upr));

        return { rr: rr_est, lwr: rr_lwr, upr: rr_upr };
    }

    // Chart Global Variable
    let myChart = null;

    // UPDATE LOGIC
    function updateDashboard() {
        // 1. Get Inputs
        const beds = parseFloat(document.getElementById('beds').value);
        const patients = parseFloat(document.getElementById('patients').value);

        if (!beds || beds <= 0) return; 

        const current_occ = patients / beds;

        // 2. Run Statistics
        const res = get_relative_risk(current_occ);
        const pct_change = res.rr - 1;
        const pct_lwr = res.lwr - 1;
        const pct_upr = res.upr - 1;

        // 3. Update Text UI
        document.getElementById('current_occ_text').innerText = fmtPct(current_occ, 1);
        document.getElementById('baseline_lbl').innerText = fmtPct(BASELINE_OCC, 0);

        const riskEl = document.getElementById('risk_text');
        riskEl.innerText = fmtPct(pct_change, 1, true);
        
        // Color logic
        if (pct_change >= 0) {
            riskEl.className = "risk-text-positive";
        } else {
            riskEl.className = "risk-text-negative";
        }

        const lwrStr = fmtPct(pct_lwr, 1, pct_lwr > 0);
        const uprStr = fmtPct(pct_upr, 1, pct_upr > 0);
        document.getElementById('risk_ci_text').innerText = `(95% CI: ${lwrStr} to ${uprStr})`;

        // 4. Update Chart
        updateChart(current_occ, pct_change);
    }

    function updateChart(userOcc, userChange) {
        const ctx = document.getElementById('riskChart').getContext('2d');
        
        // Generate Data Points for Curve (0 to 300% occupancy)
        const labels = [];
        const dataEst = [];
        const dataLwr = [];
        const dataUpr = [];
        
        // Create 100 points from 0 to 3.0
        for (let i = 0; i <= 100; i++) {
            let x = (3.0 / 100) * i; 
            let r = get_relative_risk(x);
            labels.push(x);
            dataEst.push(r.rr - 1);
            dataLwr.push(r.lwr - 1);
            dataUpr.push(r.upr - 1);
        }

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        // Upper Confidence Band (Filled to Lower Band)
                        label: 'Upper CI',
                        data: dataUpr,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)', // Light Red
                        fill: '+1', // Fill down to the next dataset (Lower CI)
                        pointRadius: 0
                    },
                    {
                        // Lower Confidence Band (Invisible line, just defines fill area)
                        label: 'Lower CI',
                        data: dataLwr,
                        borderColor: 'transparent',
                        backgroundColor: 'transparent',
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        // Main Prediction Line
                        label: 'Projected Risk',
                        data: dataEst,
                        borderColor: '#c0392b', // Dark Red
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        // User's Point ("You")
                        label: 'You',
                        data: [{x: userOcc, y: userChange}],
                        borderColor: '#2c3e50', // Dark Blue
                        backgroundColor: '#2c3e50',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false,
                        type: 'scatter'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { intersect: false, mode: 'index' },
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: 3,
                        title: { display: true, text: 'Bed Occupancy Ratio' },
                        ticks: { callback: function(val) { return fmtPct(val, 0); } }
                    },
                    y: {
                        title: { display: true, text: 'Change in Mortality Risk' },
                        ticks: { callback: function(val) { return fmtPct(val, 0); } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                if (ctx.dataset.label === 'You') return 'You: ' + fmtPct(ctx.raw.y, 1);
                                if (ctx.dataset.label === 'Upper CI') return 'Upper 95%: ' + fmtPct(ctx.raw, 1);
                                if (ctx.dataset.label === 'Lower CI') return 'Lower 95%: ' + fmtPct(ctx.raw, 1);
                                return 'Risk: ' + fmtPct(ctx.raw, 1);
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: '#7f8c8d',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                label: { 
                                    content: 'Baseline (0%)', 
                                    display: true, 
                                    position: 'start', 
                                    backgroundColor: 'rgba(255,255,255,0.8)', 
                                    color: '#7f8c8d', 
                                    yAdjust: -10 
                                }
                            },
                            line2: {
                                type: 'line',
                                xMin: BASELINE_OCC,
                                xMax: BASELINE_OCC,
                                borderColor: '#7f8c8d',
                                borderWidth: 1,
                                borderDash: [2, 2]
                            },
                            // Green Zone (Safe)
                            boxGreen: {
                                type: 'box',
                                xMin: 0,
                                xMax: BASELINE_OCC,
                                backgroundColor: 'rgba(0, 255, 0, 0.05)',
                                borderWidth: 0
                            },
                            // Red Zone (Danger)
                            boxRed: {
                                type: 'box',
                                xMin: BASELINE_OCC,
                                xMax: 3,
                                backgroundColor: 'rgba(255, 0, 0, 0.05)',
                                borderWidth: 0
                            }
                        }
                    }
                }
            }
        });
    }

    // Event Listeners
    document.getElementById('beds').addEventListener('input', updateDashboard);
    document.getElementById('patients').addEventListener('input', updateDashboard);

    // Initial Run
    updateDashboard();

</script>
</body>
</html>